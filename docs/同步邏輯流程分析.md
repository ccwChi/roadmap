# Google Drive åŒæ­¥é‚è¼¯å®Œæ•´æµç¨‹

## ğŸ” ç›®å‰çš„å•é¡Œ

```
[Sync] Google API æœªå°±ç·’ï¼Œå°‡è³‡æ–™åŠ å…¥é›¢ç·šä½‡åˆ—
[Sync] åŒæ­¥è¶…æ™‚ï¼Œå¼·åˆ¶é‡ç½®ç‹€æ…‹
```

**å•é¡Œåˆ†æ**ï¼š
1. Google API åœ¨ç™»å…¥å¾Œåˆè®Šæˆã€Œæœªå°±ç·’ã€
2. åŒæ­¥è¶…æ™‚ï¼ˆ10ç§’ï¼‰

---

## ğŸ“‹ å®Œæ•´åŒæ­¥æµç¨‹

### 1. ä½¿ç”¨è€…æ“ä½œè§¸ç™¼åŒæ­¥

**è§¸ç™¼é»**ï¼š
- Roadmap: `updateProgress()`, `setNote()`, `deleteNote()`
- Cards: `addCard()`, `updateCard()`, `deleteCard()`, `addLink()`, `removeLink()`

**æµç¨‹**ï¼š
```
ä½¿ç”¨è€…æ“ä½œ
  â†“
æ›´æ–° Zustand state
  â†“
å‘¼å« syncToCloud()
```

---

### 2. syncToCloud() åŸ·è¡Œæµç¨‹

#### Roadmap åŒæ­¥ (useStore.js)

```javascript
// ä½ç½®: store/useStore.js, line 119-209

syncToCloud: (() => {
  let timeout = null;
  return () => {
    // 1. é˜²æŠ–å‹• 500ms
    if (timeout) clearTimeout(timeout);
    timeout = setTimeout(async () => {
      
      // 2. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const { isSignedIn } = get();
      if (!isSignedIn) return;
      
      // 3. æº–å‚™åŒæ­¥è³‡æ–™
      const syncData = {
        progress,
        notes,
        settings,
        updatedAt: new Date().toISOString()
      };
      
      // 4. æª¢æŸ¥ç¶²è·¯ç‹€æ…‹
      const isReallyOnline = navigator.onLine;
      
      // 5. é›¢ç·šè™•ç†
      if (isOffline || !isReallyOnline) {
        // åŠ å…¥é›¢ç·šä½‡åˆ—
        queueSync(syncData);
        return;
      }
      
      // 6. è¨­å®šåŒæ­¥ä¸­ç‹€æ…‹
      set({ isSyncing: true });
      
      // 7. è¶…æ™‚ä¿è­·ï¼ˆ10ç§’ï¼‰
      const timeoutId = setTimeout(() => {
        console.warn('[Sync] åŒæ­¥è¶…æ™‚');
        set({ isSyncing: false, syncError: 'åŒæ­¥è¶…æ™‚' });
      }, 10000);
      
      try {
        // 8. æª¢æŸ¥ Google API æ˜¯å¦é…ç½®
        if (!isGoogleConfigured()) {
          clearTimeout(timeoutId);
          set({ isSyncing: false });
          return;
        }
        
        // 9. ç­‰å¾… Google API å°±ç·’ï¼ˆ5ç§’ï¼‰âš ï¸ å•é¡Œå¯èƒ½åœ¨é€™è£¡
        try {
          await waitForGoogleApiReady(5000);
        } catch {
          // API æœªå°±ç·’ï¼ŒåŠ å…¥é›¢ç·šä½‡åˆ—
          queueSync(syncData);
          clearTimeout(timeoutId);
          set({ isSyncing: false });
          return;
        }
        
        // 10. å„²å­˜åˆ° Google Drive
        await saveData(syncData);
        
        // 11. æˆåŠŸ
        clearTimeout(timeoutId);
        set({
          lastSyncTime: new Date().toISOString(),
          isSyncing: false
        });
        
      } catch (error) {
        // 12. å¤±æ•—è™•ç†
        clearTimeout(timeoutId);
        queueSync(syncData);
        set({ isSyncing: false });
      }
      
    }, 500);
  };
})()
```

#### Cards åŒæ­¥ (useCardStore.js)

```javascript
// ä½ç½®: store/useCardStore.js, line 248-287

syncToCloud: (() => {
  let timeout = null;
  return () => {
    // 1. é˜²æŠ–å‹• 500ms
    if (timeout) clearTimeout(timeout);
    timeout = setTimeout(async () => {
      
      // 2. æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      const { useStore } = await import('@/store/useStore');
      const isSignedIn = useStore.getState().isSignedIn;
      if (!isSignedIn) return;
      
      // 3. æº–å‚™è³‡æ–™
      const { cards, cardContents } = get();
      
      try {
        // 4. åŒæ­¥å…ƒè³‡æ–™
        await saveCardsMetadata(cards);
        
        // 5. åŒæ­¥å…§å®¹
        const syncPromises = Object.entries(cardContents).map(
          ([cardId, content]) => saveCardContent(cardId, content)
        );
        await Promise.all(syncPromises);
        
        console.log('[CardStore] é›²ç«¯åŒæ­¥å®Œæˆ');
        
      } catch (error) {
        console.log('[CardStore] é›²ç«¯åŒæ­¥å¤±æ•—:', error.message);
      }
      
    }, 500);
  };
})()
```

---

### 3. Google API ç›¸é—œå‡½æ•¸

#### isGoogleConfigured()

```javascript
// ä½ç½®: lib/googleDrive.js, line 29-31

export const isGoogleConfigured = () => {
  return Boolean(CLIENT_ID);
};
```

**æª¢æŸ¥**ï¼šç’°å¢ƒè®Šæ•¸ `NEXT_PUBLIC_GOOGLE_CLIENT_ID` æ˜¯å¦å­˜åœ¨

#### waitForGoogleApiReady()

```javascript
// ä½ç½®: lib/googleDrive.js, line 193-211

export const waitForGoogleApiReady = (timeout = 5000) => {
  return new Promise((resolve, reject) => {
    // 1. å¦‚æœå·²å°±ç·’ï¼Œç›´æ¥è¿”å›
    if (isGoogleApiReady()) {
      resolve(true);
      return;
    }
    
    // 2. ç­‰å¾…å°±ç·’
    const startTime = Date.now();
    const checkInterval = setInterval(() => {
      if (isGoogleApiReady()) {
        clearInterval(checkInterval);
        resolve(true);
      }
      
      // 3. è¶…æ™‚
      if (Date.now() - startTime > timeout) {
        clearInterval(checkInterval);
        reject(new Error('ç­‰å¾… Google API å°±ç·’è¶…æ™‚'));
      }
    }, 100);
  });
};
```

#### isGoogleApiReady()

```javascript
// ä½ç½®: lib/googleDrive.js, line 183-191

export const isGoogleApiReady = () => {
  if (typeof window === 'undefined') return false;
  
  // æª¢æŸ¥ gapi å’Œ google.accounts æ˜¯å¦è¼‰å…¥
  const gapiReady = window.gapi?.client?.getToken() != null;
  const gisReady = window.google?.accounts?.oauth2 != null;
  
  return gapiReady && gisReady;
};
```

**é—œéµæª¢æŸ¥**ï¼š
1. `window.gapi.client.getToken()` - æ˜¯å¦æœ‰ token
2. `window.google.accounts.oauth2` - OAuth æ˜¯å¦è¼‰å…¥

---

## âš ï¸ å¯èƒ½çš„å•é¡Œé»

### å•é¡Œ 1: Token éæœŸ

**ç—‡ç‹€**ï¼šç™»å…¥å¾Œç¬¬ä¸€æ¬¡åŒæ­¥æˆåŠŸï¼Œä¹‹å¾Œå¤±æ•—

**åŸå› **ï¼š
- Google OAuth token å¯èƒ½éæœŸ
- `gapi.client.getToken()` è¿”å› `null`

**æª¢æŸ¥æ–¹å¼**ï¼š
```javascript
// åœ¨ Console åŸ·è¡Œ
console.log('Token:', window.gapi?.client?.getToken());
console.log('OAuth:', window.google?.accounts?.oauth2);
```

### å•é¡Œ 2: API è…³æœ¬æœªè¼‰å…¥

**ç—‡ç‹€**ï¼š`waitForGoogleApiReady` ä¸€ç›´è¶…æ™‚

**åŸå› **ï¼š
- Google API è…³æœ¬è¼‰å…¥å¤±æ•—
- ç¶²è·¯å•é¡Œ

**æª¢æŸ¥æ–¹å¼**ï¼š
```javascript
// åœ¨ Console åŸ·è¡Œ
console.log('gapi:', window.gapi);
console.log('google.accounts:', window.google?.accounts);
```

### å•é¡Œ 3: åŒæ­¥å¤ªé »ç¹

**ç—‡ç‹€**ï¼šåŒæ­¥è¶…æ™‚

**åŸå› **ï¼š
- é˜²æŠ–å‹• 500ms å¯èƒ½ä¸å¤ 
- å¤šå€‹æ“ä½œåŒæ™‚è§¸ç™¼åŒæ­¥

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- å¢åŠ é˜²æŠ–å‹•æ™‚é–“åˆ° 1000ms
- åŠ å…¥åŒæ­¥ä½‡åˆ—

---

## ğŸ”§ å»ºè­°çš„ä¿®å¾©æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: å¢åŠ  Token åˆ·æ–°æ©Ÿåˆ¶

åœ¨ `waitForGoogleApiReady` ä¸­åŠ å…¥ token æª¢æŸ¥ï¼š

```javascript
export const waitForGoogleApiReady = async (timeout = 5000) => {
  // æª¢æŸ¥ token æ˜¯å¦éæœŸ
  const token = window.gapi?.client?.getToken();
  if (token && isTokenExpired(token)) {
    // åˆ·æ–° token
    await refreshToken();
  }
  
  // åŸæœ‰é‚è¼¯...
};
```

### æ–¹æ¡ˆ 2: ç°¡åŒ–åŒæ­¥é‚è¼¯

**ç§»é™¤é›¢ç·šä½‡åˆ—**ï¼ˆæš«æ™‚ï¼‰ï¼Œç›´æ¥åŒæ­¥æˆ–å¤±æ•—ï¼š

```javascript
syncToCloud: async () => {
  if (!isSignedIn) return;
  if (!isGoogleConfigured()) return;
  
  try {
    set({ isSyncing: true });
    await saveData(syncData);
    set({ isSyncing: false, lastSyncTime: new Date() });
  } catch (error) {
    set({ isSyncing: false, syncError: error.message });
  }
}
```

### æ–¹æ¡ˆ 3: å¢åŠ è©³ç´°æ—¥èªŒ

åœ¨æ¯å€‹æ­¥é©ŸåŠ å…¥ console.logï¼š

```javascript
console.log('[Sync] 1. é–‹å§‹åŒæ­¥');
console.log('[Sync] 2. æª¢æŸ¥ç™»å…¥:', isSignedIn);
console.log('[Sync] 3. æª¢æŸ¥ API é…ç½®:', isGoogleConfigured());
console.log('[Sync] 4. ç­‰å¾… API å°±ç·’...');
// ...
```

---

## ğŸ§ª è¨ºæ–·æ­¥é©Ÿ

### 1. æª¢æŸ¥ç’°å¢ƒè®Šæ•¸

```javascript
// Console
console.log('CLIENT_ID å­˜åœ¨:', !!process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID);
```

### 2. æª¢æŸ¥ Google API ç‹€æ…‹

```javascript
// Console
console.log('gapi:', window.gapi);
console.log('Token:', window.gapi?.client?.getToken());
console.log('OAuth:', window.google?.accounts);
```

### 3. æª¢æŸ¥ç™»å…¥ç‹€æ…‹

```javascript
// Console
const { useStore } = await import('@/store/useStore');
console.log('å·²ç™»å…¥:', useStore.getState().isSignedIn);
console.log('ä½¿ç”¨è€…:', useStore.getState().user);
```

### 4. æ‰‹å‹•è§¸ç™¼åŒæ­¥

```javascript
// Console
const { useStore } = await import('@/store/useStore');
await useStore.getState().syncToCloud();
```

---

## ğŸ“ å»ºè­°çš„ä¸‹ä¸€æ­¥

1. **å…ˆåœ¨ Console åŸ·è¡Œè¨ºæ–·æ­¥é©Ÿ 1-3**
2. **å‘Šè¨´æˆ‘çµæœ**
3. **æ ¹æ“šçµæœæ±ºå®šä¿®å¾©æ–¹æ¡ˆ**

æˆ‘éœ€è¦çŸ¥é“ï¼š
- Token æ˜¯å¦å­˜åœ¨ï¼Ÿ
- Google API æ˜¯å¦è¼‰å…¥ï¼Ÿ
- ç™»å…¥ç‹€æ…‹æ˜¯å¦æ­£ç¢ºï¼Ÿ

é€™æ¨£æˆ‘æ‰èƒ½æ‰¾å‡ºçœŸæ­£çš„å•é¡Œï¼

---

**å»ºç«‹æ™‚é–“**ï¼š2026-01-04  
**ç›®çš„**ï¼šè¨ºæ–·åŒæ­¥å•é¡Œ  
**ç‹€æ…‹**ï¼šç­‰å¾…è¨ºæ–·çµæœ
